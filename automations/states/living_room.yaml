###############################################################################
### ==> An
###############################################################################

###
# Coming from 'Bewohnt' (Occupied) or 'Leer' (Empty)
# Event either 'main switch' (1002) or 'up button' (2002)
# TV is off
###

- id: state_living_room_set_to_on_with_remote
  alias: "Wohnzimmer - Zustand mit Remote auf An schalten"
  trigger:
    - platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_switch_wohnzimmer_1
        event: 1002
    - platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_switch_wohnzimmer_2
        event: 1002
    - platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_switch_wohnzimmer_1
        event: 2002
    - platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_switch_wohnzimmer_2
        event: 2002
  condition:
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.state_living_room
          state: 'Leer'
        - condition: state
          entity_id: input_select.state_living_room
          state: 'Bewohnt'
    - condition: or
      conditions:
      - condition: state
        entity_id: media_player.fernseher_wohnzimmer
        state: 'off'
      - condition: state
        entity_id: media_player.fernseher_wohnzimmer
        state: 'unavailable'
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.state_living_room
        option: 'An'

###
# Coming from every state
# Event either 'up button' (2002) or TV turning off
###

- id: state_living_room_set_to_on_from_dimmed
  alias: "Wohnzimmer - Zustand auf An schalten"
  trigger:
    - platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_switch_wohnzimmer_1
        event: 2002
    - platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_switch_wohnzimmer_2
        event: 2002
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.state_living_room
        option: 'An'

###
# Coming from 'Gedaemmt' (Dimmed)
# Event TV turning off
# Sun is down
###

- id: state_living_room_set_to_on_from_dimmed_turning_tv_off
  alias: "Wohnzimmer - Zustand auf An schalten wenn der Fernseher ausgeschaltet wird"
  trigger:
    - platform: state
      entity_id: media_player.fernseher_wohnzimmer
      to: 'off'
      for: '00:00:12'
    - platform: state
      entity_id: media_player.fernseher_wohnzimmer
      to: 'unavailable'
      for: '00:00:12'
  condition:
    - condition: state
      entity_id: input_select.state_living_room
      state: 'Gedaemmt'
    - condition: state
      entity_id: sun.sun
      state: 'below_horizon'
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.state_living_room
        option: 'An'

###############################################################################
### ==> Leer
###############################################################################

###
# Coming from 'Bewohnt' (Occupied)
# Event 'No occupancy'
###

- id: state_living_room_set_to_empty_automatically
  alias: "Wohnzimmer - Zustand auf Leer schalten"
  trigger:
    - platform: state
      entity_id: binary_sensor.occupancy_living_room
      to: 'off'
  condition:
    - condition: state
      entity_id: input_select.state_living_room
      state: 'Bewohnt'
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.state_living_room
        option: 'Leer'

###
# Coming from either 'An' (On) or 'Gedaemmt' (Dimmed)
# Event 'main switch'
# No occupancy
###

- id: state_living_room_set_to_off_with_remote_no_occupancy
  alias: "Wohnzimmer - Zustand mit Remote auf Aus schalten, wenn niemand da ist"
  trigger:
    - platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_switch_wohnzimmer_1
        event: 1002
    - platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_switch_wohnzimmer_2
        event: 1002
  condition:
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.state_living_room
          state: 'Gedaemmt'
        - condition: state
          entity_id: input_select.state_living_room
          state: 'An'
    - condition: state
      entity_id: binary_sensor.occupancy_living_room
      state: 'off'
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.state_living_room
        option: 'Leer'

###############################################################################
### ==> Bewohnt
###############################################################################

###
# Coming from 'Leer' (Empty)
# Event 'Occupied'
# TV is off
###

- id: state_living_room_set_to_occupied_on_occupancy
  alias: "Wohnzimmer - Zustand auf Bewohnt schalten wenn jemand dort ist"
  trigger:
    - platform: state
      entity_id: binary_sensor.occupancy_living_room
      to: 'on'
  condition:
    - condition: state
      entity_id: input_select.state_living_room
      state: 'Leer'
    - condition: or
      conditions:
      - condition: state
        entity_id: media_player.fernseher_wohnzimmer
        state: 'off'
      - condition: state
        entity_id: media_player.fernseher_wohnzimmer
        state: 'unavailable'
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.state_living_room
        option: 'Bewohnt'

###
# Coming from either 'An' (On) or 'Gedaemmt' (Dimmed)
# Event 'main switch'
# Occupancy
###

- id: state_living_room_set_to_occupied_with_remote
  alias: "Wohnzimmer - Zustand mit Remote auf Bewohnt schalten"
  trigger:
    - platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_switch_wohnzimmer_1
        event: 1002
    - platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_switch_wohnzimmer_2
        event: 1002
  condition:
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.state_living_room
          state: 'An'
        - condition: state
          entity_id: input_select.state_living_room
          state: 'Gedaemmt'
    - condition: state
      entity_id: binary_sensor.occupancy_living_room
      state: 'on'
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.state_living_room
        option: 'Bewohnt'

###############################################################################
### ==> Gedaemmt
###############################################################################

###
# Coming from either 'Bewohnt' (Occupied), 'An' (On) or 'Leer' (Empty)
# Event either 'TV turning on' or 'down button' (3002)
###

- id: state_living_room_set_to_dimmed
  alias: "Wohnzimmer - Zustand auf Gedämmt schalten"
  trigger:
    - platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_switch_wohnzimmer_1
        event: 3002
    - platform: event
      event_type: deconz_event
      event_data:
        id: tradfri_switch_wohnzimmer_2
        event: 3002
    - platform: state
      entity_id: media_player.fernseher_wohnzimmer
      to: 'on'
  condition:
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.state_living_room
          state: 'Bewohnt'
        - condition: state
          entity_id: input_select.state_living_room
          state: 'An'
        - condition: state
          entity_id: input_select.state_living_room
          state: 'Leer'
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.state_living_room
        option: 'Gedaemmt'

###
# Coming from 'Leer' (Empty)
# Event either 'TV turning on' or 'down button' (3002)
###

- id: state_living_room_set_to_dimmed_on_occupancy_with_tv_on
  alias: "Wohnzimmer - Zustand auf Gedämmt schalten wenn jemand dort ist und der Fernseher läuft"
  trigger:
    - platform: state
      entity_id: binary_sensor.occupancy_living_room
      to: 'on'
  condition:
    - condition: state
      entity_id: input_select.state_living_room
      state: 'Leer'
    - condition: state
      entity_id: media_player.fernseher_wohnzimmer
      state: 'on'
  action:
    - service: input_select.select_option
      data:
        entity_id: input_select.state_living_room
        option: 'Gedaemmt'